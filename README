FSM for parsing and processing formatting for ruby's String#% 